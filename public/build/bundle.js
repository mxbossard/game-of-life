var app=function(){"use strict";function t(){}function e(t){return t()}function n(){return Object.create(null)}function o(t){t.forEach(e)}function i(t){return"function"==typeof t}function r(t,e){return t!=t?e==e:t!==e||t&&"object"==typeof t||"function"==typeof t}function s(t,e){t.appendChild(e)}function l(t,e,n){t.insertBefore(e,n||null)}function a(t){t.parentNode.removeChild(t)}function h(t){return document.createElement(t)}function c(t){return document.createTextNode(t)}function u(){return c(" ")}function f(t,e,n,o){return t.addEventListener(e,n,o),()=>t.removeEventListener(e,n,o)}function d(t,e,n){null==n?t.removeAttribute(e):t.getAttribute(e)!==n&&t.setAttribute(e,n)}function g(t,e){e=""+e,t.wholeText!==e&&(t.data=e)}function p(t,e){t.value=null==e?"":e}let y;function w(t){y=t}function m(t){(function(){if(!y)throw new Error("Function called outside component initialization");return y})().$$.on_mount.push(t)}const C=[],v=[],b=[],M=[],E=Promise.resolve();let k=!1;function S(t){b.push(t)}let $=!1;const T=new Set;function D(){if(!$){$=!0;do{for(let t=0;t<C.length;t+=1){const e=C[t];w(e),R(e.$$)}for(C.length=0;v.length;)v.pop()();for(let t=0;t<b.length;t+=1){const e=b[t];T.has(e)||(T.add(e),e())}b.length=0}while(C.length);for(;M.length;)M.pop()();k=!1,$=!1,T.clear()}}function R(t){if(null!==t.fragment){t.update(),o(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(S)}}const x=new Set;function O(t,e){-1===t.$$.dirty[0]&&(C.push(t),k||(k=!0,E.then(D)),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function A(r,s,l,h,c,u,f=[-1]){const d=y;w(r);const g=s.props||{},p=r.$$={fragment:null,ctx:null,props:u,update:t,not_equal:c,bound:n(),on_mount:[],on_destroy:[],before_update:[],after_update:[],context:new Map(d?d.$$.context:[]),callbacks:n(),dirty:f};let m=!1;if(p.ctx=l?l(r,g,(t,e,...n)=>{const o=n.length?n[0]:e;return p.ctx&&c(p.ctx[t],p.ctx[t]=o)&&(p.bound[t]&&p.bound[t](o),m&&O(r,t)),e}):[],p.update(),m=!0,o(p.before_update),p.fragment=!!h&&h(p.ctx),s.target){if(s.hydrate){const t=function(t){return Array.from(t.childNodes)}(s.target);p.fragment&&p.fragment.l(t),t.forEach(a)}else p.fragment&&p.fragment.c();s.intro&&((C=r.$$.fragment)&&C.i&&(x.delete(C),C.i(v))),function(t,n,r){const{fragment:s,on_mount:l,on_destroy:a,after_update:h}=t.$$;s&&s.m(n,r),S(()=>{const n=l.map(e).filter(i);a?a.push(...n):o(n),t.$$.on_mount=[]}),h.forEach(S)}(r,s.target,s.anchor),D()}var C,v;w(d)}class _{constructor(t,e,n){this.c=t,this.r=e,this.strategy=n,this.alive=!0}key(){return K.cellKey(this.c,this.r)}static parse(t){return K.parseCell(t)}}class P{constructor(t){this.cell=t,this.fightCount=0,this.winByStrategyCount=new Map,this.scoreByStrategyCount=new Map,this.winCount=0,this.score=0}addScore(t,e,n){this.fightCount++,t&&(this.score+=t),t>n&&this.winCount++;let o=this.winByStrategyCount.get(e.strategy.name)||0;this.winByStrategyCount.set(e.strategy.name,o+1);let i=this.scoreByStrategyCount.get(e.strategy.name)||0;this.scoreByStrategyCount.set(e.strategy.name,i+n)}isGreaterThan(t){return!t||(this.score>t.score||this.fightCount>t.fightCount)}}class K{static cellKey(t,e){return t+";"+e}static parseCell(t){const[e,n]=t.split(";");return{r:parseInt(n,10),c:parseInt(e,10)}}static fightKey(t,e){return K.cellKey(t.c,t.r)+"_"+K.cellKey(e.c,e.r)}static initArena(){let t=2*N.length,e=2*Math.PI/t,n=10*t/(2*Math.PI);for(let o=0;o<t;o++){let t=Math.ceil(Math.cos(o*e)*n),i=Math.ceil(Math.sin(o*e)*n),r=Math.floor(o/N.length),s=(r+1)*N.length-r*Math.round(1*N.length/2)+o%N.length*Math.pow(-1,r)-Math.floor(3*r/2);console.debug("k:",o,"indice:",r,"position:",s);for(let e=Math.floor(-1);e<=1;e++)for(let n=Math.floor(-1);n<=1;n++){if(Math.sqrt(Math.pow(e,2)+Math.pow(n,2))<=1){let o=new _(t+e,i+n,N[s%N.length]);Y.spawn(o)}}}}}const B=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]];const Y=new class{constructor(t,e){this.roundCount=t,this.livings=new Map,this.neigborhoodsMap=new Map,this.fightsDone=new Set,this.scoreboard=new Map,this.leaderboard=[],this.fightResultCacheDisabled=!1,this.fightResultCache=new Map,this.boundary=e}clear(){this.livings=new Map,this.fightsDone=new Set,this.scoreboard=new Map,this.leaderboard=[],K.initArena()}spawn(t){let e=t.key();if(this.livings.has(e))throw new Error("Trying to spawn a cell on a living cell !");this.livings.set(e,t)}neigborhoodsKeys(t){let e=t.key();if(this.neigborhoodsMap.has(e))return this.neigborhoodsMap.get(e);let n=[],o=[];for(let[e,n]of B){let i=t.r+n,r=t.c+e,s=Math.sqrt(Math.pow(t.c,2)+Math.pow(t.r,2)),l=Math.sqrt(Math.pow(r,2)+Math.pow(i,2)),a=3+l-s;o.push([a,l,r,i])}o.sort();for(let[t,e,i,r]of o)if(this.boundary>0&&(i>this.boundary||i<-this.boundary|r>this.boundary||r<-this.boundary));else{let t=K.cellKey(i,r);n.push(t)}let i=[n];return this.neigborhoodsMap.set(e,i),i}giveBirth(t){let e=[],[n]=this.neigborhoodsKeys(t);for(let o of n)if(!this.livings.has(o)){let n=K.parseCell(o),i=new _(n.c,n.r,t.strategy);e.push(i);break}return e}kill(t){let e=t.key();this.livings.delete(e)}fight(t,e){let n=K.fightKey(t,e);if(this.fightsDone.has(n))return;let o=0,i=0,r=t.strategy.name+";"+e.strategy.name;if(!this.fightResultCache.has(r)||this.fightResultCacheDisabled){let n=t.strategy,s=e.strategy,l=[],a=[];for(let t=0;t<this.roundCount;t++){let e=n.play(t,l,a,this.roundCount),r=s.play(t,a,l,this.roundCount);if(l.push(e),a.push(r),"COOPERATE"==e&&"COOPERATE"==r)o+=3,i+=3;else if("COOPERATE"==e&&"DEFECT"==r)i+=5;else if("DEFECT"==e&&"COOPERATE"==r)o+=5;else{if("DEFECT"!=e||"DEFECT"!=r)throw new Error("Not supported play [",+e+" ; "+r+"] for strategies ["+n.name+" ; "+s.name+"] !");o+=1,i+=1}}this.fightResultCache.set(r,[o,i])}else[o,i]=this.fightResultCache.get(r);let s=this.scoreboard.get(t.key())||new P(t);s.addScore(o,e,i),this.scoreboard.set(t.key(),s);let l=this.scoreboard.get(e.key())||new P(e);l.addScore(i,t,o),this.scoreboard.set(e.key(),l),this.fightsDone.add(K.fightKey(t,e)),this.fightsDone.add(K.fightKey(e,t))}isDying(t){let e=this.scoreboard.get(t.key());if(!e)return!0;let[n]=this.neigborhoodsKeys(t),o=0,i=e.score,r=new Map;for(let e=0;e<n.length;e++){let s=n[e];if(this.livings.has(s)){let e=this.livings.get(s);t.strategy.name===e.strategy.name&&o++;let n=r.get(e.strategy.name)||0;r.set(e.strategy.name,n+1)}let l=this.scoreboard.get(s);l&&(i+=l.score)}if(0===o)return!0;let s=Array.from(r.values()),l=!1;if(r.forEach((n,o,i)=>{l=l||e.scoreByStrategyCount.get(t.strategy.name)<e.scoreByStrategyCount.get(o)}),l)return!0;for(let t=0;t<s.length;t++)if(o<s[t])return e.score<i/(n.length+1);return e.score<i/(n.length+1)*8/10}isGivingBirth(t){let e=this.scoreboard.get(t.key());if(!e)return!1;let[n]=this.neigborhoodsKeys(t),o=0,i=e.score;for(let e=0;e<n.length;e++){let r=n[e];if(this.livings.has(r)){let e=this.livings.get(r);t.strategy===e.strategy&&o++}let s=this.scoreboard.get(r);s&&(i+=s.score)}return o>2&&e.score>=i/(n.length+1)}isAdapted(t){if(!this.scoreboard.get(t.key()))return!1;let[e]=this.neigborhoodsKeys(t);for(let t of e){this.scoreboard.get(t)}if(this.scoreboard.has(t.key())){let e,n,o,i,r,s=this.scoreboard.get(t.key());if(s.fightCount<=1)return!0;let l=0;for([e,n]of B){i=t.r+n,o=t.c+e,r=K.cellKey(o,i);let a=this.scoreboard.get(r);a&&s.isGreaterThan(a)&&l++}return l>s.fightCount-2}throw new Error("Cell do not have a score !")}step(){let t,e,n,o,i,r,s=this,l=[],a=[];this.fightsDone=new Set,this.scoreboard=new Map,this.leaderboard=[],this.fightResultCache=new Map,this.livings.forEach((l,a,h)=>{for([e,t]of B)n=l.r+t,o=l.c+e,i=K.cellKey(o,n),r=this.livings.has(i)?this.livings.get(i):new _(o,n,I),s.fight(l,r)});let h=new Map,c=new Map;return this.livings.forEach((t,e,n)=>{if(s.isDying(t))a.push(t);else if(s.isGivingBirth(t)){let e=this.giveBirth(t);e&&(h.set(t,e),e.forEach(e=>{let n,o=e.key();c.has(o)?n=c.get(o):(n=[],c.set(o,n)),n.push(t)}))}}),c.forEach((t,e,n)=>{let o,i;t.forEach(t=>{let e=this.scoreboard.get(t.key());e.isGreaterThan(o)&&(o=e,i=t)}),h.get(i).forEach(t=>{this.spawn(t),l.push(t)})}),a.forEach(t=>this.kill(t)),console.info("births:",l),console.info("deaths:",a),[l,a]}}(100,30),X=new function(){this.name="CooperativeStrategy",this.color="forestgreen",this.play=function(t,e,n,o){return"COOPERATE"}};const F=new function(){this.name="DefectiveStrategy",this.color="red",this.play=function(t,e,n,o){return"DEFECT"}};const G=new function(){this.name="DonnantDonnantStrategy",this.color="pink",this.play=function(t,e,n,o){return 0==t?"COOPERATE":n[t-1]}};const q=new function(){this.name="PerCDStrategy",this.color="yellow",this.play=function(t,e,n,o){return"COOPERATE"}};const z=new function(){this.name="PerCCDStrategy",this.color="lightgreen",this.play=function(t,e,n,o){return t%3<2?"COOPERATE":"DEFECT"}};const I=new function(){let t=this;this.name="RandomStrategy",this.color="white",this.plays=[];for(let e=0;e<Y.roundCount;e++)2*Math.random()<2?t.plays.push("COOPERATE"):t.plays.push("DEFECT");this.play=function(t,e,n,o){return 2*Math.random()<2?"COOPERATE":"DEFECT"}};const N=[X,F,q,z,G];K.initArena();const L=new function(){this.clear=function(){Y.clear()},this.step=function(){return Y.step()},this.livingSet=function(){return new Set(Y.livings.values())},this.isCellAlive=function(t){throw new Error("Not supported yet !")},this.update=function(t,e){}};function j(t){let e;return{c(){e=h("ul"),e.innerHTML='<li><a href="https://en.wikipedia.org/wiki/Conway%27s_Game_of_Life">Conway&#39;s Game of Life</a>.</li> \n        <li>Click or touch and drag to draw shapes</li> \n        <li>Press Run to see them evolve</li> \n        <li>Use W,A,S,D or arrows to move around, mouse wheel to zoom</li> \n        <li>Or touch with two fingers to pan and zoom</li>'},m(t,n){l(t,e,n)},d(t){t&&a(e)}}}function H(e){let n,r,y,w,m,C,v,b,M,E,k,S,$,T,D,R,x,O,A,_,P,K,B,Y,X,F,G,q,z,I,N,L,H,U,W,J,Q,V,Z,tt=e[4]?"Stop":"Run",et=e[5]&&j();return{c(){n=h("div"),r=h("div"),y=h("button"),y.textContent="?",w=u(),m=h("button"),m.textContent="Clear",C=u(),v=h("button"),b=c("Step"),M=u(),E=h("button"),k=c(tt),S=u(),$=h("div"),T=h("label"),T.textContent="Speed",D=u(),R=h("input"),x=u(),O=h("div"),A=h("div"),_=c("cells:"),P=h("br"),K=c(e[6]),B=u(),Y=h("div"),X=c("step:"),F=h("br"),G=c(e[1]),q=c(" ms"),z=u(),I=h("div"),N=c("draw:"),L=h("br"),H=c(e[2]),U=c(" ms"),W=u(),et&&et.c(),J=u(),Q=h("canvas"),d(y,"type","button"),d(y,"name","help"),d(y,"title","Show help"),d(y,"class","svelte-hgu8tl"),d(m,"title","Clear all cells from grid"),d(m,"class","svelte-hgu8tl"),v.disabled=e[4],d(v,"class","svelte-hgu8tl"),d(E,"class","svelte-hgu8tl"),d(r,"class","row svelte-hgu8tl"),d(T,"for","speed"),d(R,"id","speed"),d(R,"type","range"),d(R,"min","5"),d(R,"max","500"),d(R,"step","1"),d($,"class","row svelte-hgu8tl"),d(A,"class","svelte-hgu8tl"),d(Y,"class","svelte-hgu8tl"),d(I,"class","svelte-hgu8tl"),d(O,"class","row svelte-hgu8tl"),d(n,"class","controls svelte-hgu8tl"),d(Q,"id","gridCanvas"),d(Q,"class","gridCanvas svelte-hgu8tl")},m(t,o){l(t,n,o),s(n,r),s(r,y),s(r,w),s(r,m),s(r,C),s(r,v),s(v,b),s(r,M),s(r,E),s(E,k),s(n,S),s(n,$),s($,T),s($,D),s($,R),p(R,e[3]),s(n,x),s(n,O),s(O,A),s(A,_),s(A,P),s(A,K),s(O,B),s(O,Y),s(Y,X),s(Y,F),s(Y,G),s(Y,q),s(O,z),s(O,I),s(I,N),s(I,L),s(I,H),s(I,U),s(n,W),et&&et.m(n,null),l(t,J,o),l(t,Q,o),e[23](Q),V||(Z=[f(window,"keydown",e[8]),f(window,"keyup",e[9]),f(window,"resize",e[20]),f(y,"click",e[21]),f(m,"click",e[17]),f(v,"click",e[16]),f(E,"click",(function(){i(e[4]?e[19]:e[18])&&(e[4]?e[19]:e[18]).apply(this,arguments)})),f(R,"change",e[22]),f(R,"input",e[22]),f(Q,"mouseup",e[12]),f(Q,"mousedown",e[10]),f(Q,"mousemove",e[11]),f(Q,"wheel",e[7]),f(Q,"touchstart",e[13]),f(Q,"touchmove",e[14]),f(Q,"touchend",e[15]),f(Q,"touchcancel",e[15])],V=!0)},p(t,o){e=t,16&o[0]&&(v.disabled=e[4]),16&o[0]&&tt!==(tt=e[4]?"Stop":"Run")&&g(k,tt),8&o[0]&&p(R,e[3]),64&o[0]&&g(K,e[6]),2&o[0]&&g(G,e[1]),4&o[0]&&g(H,e[2]),e[5]?et||(et=j(),et.c(),et.m(n,null)):et&&(et.d(1),et=null)},i:t,o:t,d(t){t&&a(n),et&&et.d(),t&&a(J),t&&a(Q),e[23](null),V=!1,o(Z)}}}function U(t,e){return{r:Math.floor(e),c:Math.floor(t)}}function W(t,e){const n=[];if(e>t)for(let o=Math.ceil(t);o<e;o++)n.push(o);else for(let o=Math.floor(t);o>e;o--)n.push(o);return n}function J(t,e,n,o){const i=n-t,r=o-e;let s,l,a=[];for(s of W(t,n))l=e+r*(s-t)/i,a.push(U(s-1,l)),a.push(U(s,l));for(l of W(e,o))s=t+i*(l-e)/r,a.push(U(s,l-1)),a.push(U(s,l));return a}function Q(t,e,n){let o,i,r,s,l,a=25,h=.5,c=.5,u=0,f=0,d=10,g=!1,p=!1,y=!0,w=!1,C=0;function b(){if(a>=10){const e=a*(h-Math.floor(h)),n=o.width/2-e,r=n-a*Math.floor(n/a),s=a*(c-Math.floor(c)),l=o.height/2-s,u=l-a*Math.floor(l/a);let f;i.strokeStyle="#555",i.beginPath();for(var t=0;t<Math.ceil(o.height/a);t++)f=Math.floor(u+t*a)+.5,i.moveTo(0,f),i.lineTo(o.width,f);for(t=0;t<Math.ceil(o.width/a);t++)f=Math.floor(r+t*a)+.5,i.moveTo(f,0),i.lineTo(f,o.height);i.stroke(),i.closePath()}}function M(t){i.clearRect(0,0,o.width,o.height),i.fillStyle="black",i.fillRect(0,0,o.width,o.height),b(),function(){for(let t of L.livingSet())D(t,t.strategy.color)}()}let E=new Set;function k(t){const e=o.getBoundingClientRect();return[t.clientX-e.left,t.clientY-e.top]}function S(t){const[e,n]=k(t);return function(t,e){return[h+(t-1-o.width/2)/a,c+(e-1-o.height/2)/a]}(e,n)}let $=[],T=0;function D(t,e){i.fillStyle=e;const n=function(t){return{x:Math.floor(o.width/2+1+(t.c-h)*a),y:Math.floor(o.height/2+1+(t.r-c)*a)}}(t);i.fillRect(n.x,n.y,a-(a<=2?0:1),a-(a<=2?0:1))}function R(t,e){let o=performance.now();0==t.length&0===e.length&&A(),L.update(t,e);for(let e of t)D(e,e.strategy.color);for(let t of e)D(t,"black");n(2,f=Math.round(performance.now()-o)),n(6,C=L.livingSet().size)}function x(){let t,e,o=performance.now();[t,e]=L.step(),n(1,u=Math.round(performance.now()-o)),R(t,e)}function O(){g||(r=setInterval(()=>x(),1e4/d),n(4,g=!0))}function A(){g&&(clearInterval(r),n(4,g=!1))}async function _(){n(0,o.width=10,o),n(0,o.height=10,o);const t=o.parentNode.getBoundingClientRect();n(0,o.width=t.width,o),n(0,o.height=t.height,o),M()}m(async()=>{i=o.getContext("2d"),setTimeout(_,42)});return t.$$.update=()=>{16777217&t.$$.dirty[0]&&o&&M(),8&t.$$.dirty[0]&&g&&(A(),O())},[o,u,f,d,g,w,C,function(t){t.preventDefault();const e=t.deltaY>0;let i=Math.floor(5*Math.abs(t.deltaY)*a/100);i=Math.max(i,1);const r=Math.min(Math.max(1,a+(e?-1:1)*i),200);let[s,l]=k(t);s-=o.width/2,l-=o.height/2,h=h+s/a-s/r,c=c+l/a-l/r,h=Math.round(2*h)/2,c=Math.round(2*c)/2,n(24,a=r)},function(t){87===t.keyCode|38===t.keyCode?E.add("up"):83===t.keyCode|40===t.keyCode?E.add("down"):65===t.keyCode|37===t.keyCode?E.add("left"):68===t.keyCode|39===t.keyCode&&E.add("right");const e=20/a,n=(E.has("right")?e:0)-(E.has("left")?e:0),o=(E.has("down")?e:0)-(E.has("up")?e:0);if(0!==n|0!==o){if(p){const t=J(s,l,s+n,l+o);t.length>0&&(y?R(t,[]):R([],t)),s+=n,l+=o}h+=n,c+=o,M()}},function(t){87===t.keyCode|38===t.keyCode?E.delete("up"):83===t.keyCode|40===t.keyCode?E.delete("down"):65===t.keyCode|37===t.keyCode?E.delete("left"):68===t.keyCode|39===t.keyCode&&E.delete("right")},function(t){const[e,n]=S(t),o=U(e,n);y=!L.isCellAlive(o),y?R([o],[]):R([],[o]),p=!0,s=e,l=n},function(t){if(p){const[e,n]=S(t),o=J(s,l,e,n);o.length>0&&(y?R(o,[]):R([],o)),s=e,l=n}},function(t){const[e,n]=S(t),o=U(e,n);y?R([o],[]):R([],[o]),p=!1},function(t){t.preventDefault();for(let e of t.changedTouches)$.push({id:e.identifier,clientX:e.clientX,clientY:e.clientY});if(T=performance.now(),1==$.length){const[t,e]=S($[0]),n=U(t,e);y=!L.isCellAlive(n),p=!0}else $.length>1&&(p=!1)},function(t){t.preventDefault();let e=performance.now();if(e-T>=50&&1==$.length&&p){const n=t.changedTouches[0],[o,i]=S($[0]),[r,s]=S(n),l=J(r,s,o,i);l.length>0&&(y?R(l,[]):R([],l)),$=[{id:n.identifier,clientX:n.clientX,clientY:n.clientY}],T=e}else if(e-T>=200&&2==$.length){const e=$.map(t=>t.id);let o,i=[...$];for(let n of t.changedTouches)o=e.indexOf(n.identifier),i[o]={id:n.identifier,clientX:n.clientX,clientY:n.clientY};const r=Math.sqrt(($[0].clientX-$[1].clientX)**2+($[0].clientY-$[1].clientY)**2),s=Math.sqrt((i[0].clientX-i[1].clientX)**2+(i[0].clientY-i[1].clientY)**2),l=Math.max(1,Math.round(s*a/r)),[u,f]=S($[0]),[d,g]=S($[1]);n(24,a=l);const[p,y]=S(i[0]),[w,m]=S(i[1]);h-=.5*(p-u+w-d),c-=.5*(y-f+m-g),M(),$=i}},function(t){if(t.preventDefault(),p&&1===$.length){const[e,n]=S(t.changedTouches[0]),o=U(e,n);y?R([o],[]):R([],[o]),p=!1}for(let e of t.changedTouches)$=$.filter(t=>t.id!==e.identifier);T=performance.now()},x,function(){L.clear(),M(),n(6,C=L.livingSet().size)},O,A,_,()=>n(5,w=!w),function(){var t;t=this.value,d=""===t?void 0:+t,n(3,d)},function(t){v[t?"unshift":"push"](()=>{o=t,n(0,o)})}]}return new class extends class{$destroy(){!function(t,e){const n=t.$$;null!==n.fragment&&(o(n.on_destroy),n.fragment&&n.fragment.d(e),n.on_destroy=n.fragment=null,n.ctx=[])}(this,1),this.$destroy=t}$on(t,e){const n=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return n.push(e),()=>{const t=n.indexOf(e);-1!==t&&n.splice(t,1)}}$set(){}}{constructor(t){super(),A(this,t,Q,H,r,{},[-1,-1])}}({target:document.body})}();
//# sourceMappingURL=bundle.js.map
